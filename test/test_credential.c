#include <stdlib.h>
#include <stdint.h>
#include <string.h>
#include <stdio.h>

#include <ubi_common/macros.h>
#include <ubi_common/structs.h>

#include <ubi_crypt/credential.h>
#include <ubi_crypt/rand.h>

uint8_t d[256] = {0x29,0x3F,0x4D,0xBA,0x03,0x79,0x07,0xB7,0xB6,0xB2,0x22,0xDF,0xAC,0xA6,0xA4,0xF2,0xEB,0x4B,0x9A,0xF6,0x14,0xDF,0x1A,0x93,0xFB,0x3C,0xC0,0x00,0x95,0x14,0x86,0xF4,0x1B,0xDC,0x44,0x90,0x84,0x69,0x78,0xDD,0x76,0x41,0x1E,0xDC,0x21,0xA2,0xAF,0x70,0x52,0xBC,0xD1,0x63,0xAD,0xAC,0x5C,0xE8,0x94,0xA9,0x49,0xD8,0x68,0x8E,0xF8,0xD3,0xD8,0xD9,0x30,0xA8,0xBA,0x78,0xA4,0xDE,0xE5,0xD6,0xE8,0xC5,0xAC,0x9D,0xE7,0x67,0x8D,0x21,0x98,0xBE,0x36,0x0B,0xF0,0xED,0x86,0x6A,0xB8,0x11,0x2B,0xDC,0x7D,0xF4,0x59,0x90,0xE5,0xF9,0x53,0x2D,0xC4,0x1D,0x5D,0x8E,0x25,0x97,0xBD,0xAB,0x15,0x8F,0xFF,0x6D,0x34,0xDD,0x2C,0x7E,0xA1,0xBD,0x00,0x5F,0xA0,0x94,0xA1,0x3F,0xED,0xC1,0x9C,0x27,0x5B,0x3E,0xF4,0xEF,0x3A,0xA4,0x36,0x68,0x2C,0x39,0xD9,0xAC,0xB7,0x2A,0xD3,0x43,0xEB,0x98,0x70,0x55,0x91,0xB4,0xF3,0x1B,0x40,0xC6,0x84,0xAC,0xD5,0xDF,0x6B,0x30,0x89,0x99,0x89,0x96,0x53,0x3C,0x3A,0x9F,0x4F,0x96,0xD0,0xAC,0xE0,0x0A,0xFA,0x4A,0xE1,0xDE,0x39,0x18,0xA9,0x38,0x9D,0xFE,0xC5,0x9E,0x25,0x8F,0x1A,0x56,0x4D,0x91,0x86,0x0A,0xA6,0xDC,0x8B,0xDF,0x84,0x6F,0x89,0x33,0x89,0xAD,0x52,0x98,0x63,0xC8,0xC7,0x2B,0xE2,0x40,0xDB,0x42,0xF4,0x30,0xEF,0xB9,0xF5,0x1E,0xDF,0x8E,0x4E,0xCD,0xAC,0x51,0xB5,0x34,0xB1,0x12,0xCD,0x39,0x62,0x3C,0x1B,0x09,0xB6,0xAA,0xA1,0x5D,0x1E,0x13,0x30,0x27,0x98,0xDC,0xCB,0x46,0x14,0xCA,0x1E,0x06,0x4E,0x31};
uint8_t n[256] = {0xC7,0xA5,0xAE,0x58,0xCF,0x47,0x13,0x25,0xDC,0x09,0x41,0x9A,0x7F,0xA0,0xBD,0x40,0x0F,0xB3,0xE2,0xB0,0x35,0xA4,0x7A,0xE0,0xB9,0x73,0xFF,0xA5,0xA5,0x31,0x28,0x9F,0xC7,0x70,0x03,0x44,0x4F,0x72,0x5F,0x92,0xC6,0xDF,0xCD,0xBB,0x30,0x27,0x0B,0x53,0x4E,0xAC,0xA9,0x1C,0xF2,0x9D,0x5A,0xC5,0x6B,0x0C,0x73,0x49,0xEF,0x0C,0x33,0xC8,0x5E,0xA1,0x44,0x54,0x01,0x89,0xDB,0x63,0x33,0x01,0xDD,0x4C,0x42,0x51,0x4C,0xDD,0x86,0x1C,0x17,0xE5,0x0D,0xBA,0xB4,0xA0,0x78,0x40,0xB5,0x6D,0xCF,0x67,0x1D,0x6F,0x64,0x00,0xE6,0x1A,0x09,0xA9,0xC5,0x5F,0x3F,0x37,0x31,0x31,0x99,0x0C,0x63,0x6E,0xE3,0x96,0x33,0xC6,0x3E,0xFE,0x87,0x97,0xF9,0xE2,0xD3,0x62,0x6D,0x24,0x34,0xF9,0xB9,0x43,0x61,0x9D,0x8D,0xA5,0xDA,0x99,0xE0,0xCA,0x5E,0x86,0xA9,0xFF,0xDB,0x6B,0x54,0xBD,0xCD,0x29,0xE2,0xC0,0x6C,0x9F,0xE3,0x42,0x34,0x6B,0xE8,0x88,0x95,0x9D,0x67,0x40,0x89,0x8A,0xC3,0x88,0x7B,0x16,0xAC,0x7C,0x1C,0x17,0x11,0x1C,0x17,0x05,0x0F,0xCA,0xB6,0x59,0xCF,0x1F,0xF0,0x4D,0xD3,0xAF,0xEB,0x7F,0xA0,0x55,0xEB,0x10,0x1A,0x84,0x8D,0xF8,0xF0,0x25,0x01,0x45,0x89,0xA0,0x00,0x81,0xDB,0x59,0xFF,0xA0,0x3B,0x7D,0xF5,0xEA,0x9C,0x90,0xC9,0xC9,0xED,0x3E,0xE9,0x28,0x1E,0xAE,0xA2,0x3B,0x94,0x8B,0x4B,0x42,0xE8,0x50,0x07,0x6F,0xC8,0xF0,0xE0,0x3A,0x99,0x61,0x8B,0x29,0x13,0xDD,0xF6,0xA2,0x58,0xAF,0xCB,0x28,0x0E,0x84,0x0E,0x99,0x21,0x37,0x9C,0x55};
uint8_t e[3] = {0x01,0x00,0x01};
uint8_t name[SHA256_DIGEST_LENGTH + 2] = {0x00, 0x0b, 0xf7, 0xc1, 0x04, 0x8c, 0x24, 0x7d, 0xfb, 0x47, 0x61, 0x2e, 0x4e, 0x66, 0xf4, 0xa5, 0x6c, 0xff, 0xf2, 0x29, 0xc9, 0x88, 0xa4, 0x27, 0x2c, 0xc6, 0xb1, 0x2a, 0x7c, 0x30, 0x2d, 0x66, 0x6d, 0x6d};

int main(void)
{
    struct ubi_make_credential_in *make_in = (ubi_make_credential_in*)calloc(1,sizeof(ubi_make_credential_in));
    struct ubi_make_credential_out *make_out = NULL;
    struct ubi_activate_credential_in *activate_in = (ubi_activate_credential_in*)calloc(1,sizeof(ubi_activate_credential_in));
    struct ubi_activate_credential_out *activate_out = NULL;

    make_in->key_e = calloc(1,sizeof(ubi_buffer));
    make_in->key_e->buffer_len = sizeof(e);
    make_in->key_e->buffer = calloc(1,make_in->key_e->buffer_len);
    make_in->key_n = calloc(1,sizeof(ubi_buffer));
    make_in->key_n->buffer_len = sizeof(n);
    make_in->key_n->buffer = calloc(1,make_in->key_n->buffer_len);
    make_in->key_name = calloc(1,sizeof(ubi_buffer));
    make_in->key_name->buffer_len = SHA256_DIGEST_LENGTH + 2;
    make_in->key_name->buffer = calloc(1,make_in->key_name->buffer_len);
    make_in->secret = calloc(1,sizeof(ubi_buffer));
    make_in->secret->buffer_len = 60;
    make_in->secret->buffer = calloc(1,make_in->secret->buffer_len);

    ubi_random_bytes(NULL, (*make_in).secret->buffer, 60);

    memcpy((*make_in).key_n->buffer, n, make_in->key_n->buffer_len);
    memcpy((*make_in).key_e->buffer, e, make_in->key_e->buffer_len);
    memcpy((*make_in).key_name->buffer, name, make_in->key_name->buffer_len);

    ubi_make_credential(make_in, &make_out);

    activate_in->auth_digest = calloc(1,sizeof(ubi_buffer));
    activate_in->auth_digest->buffer_len = make_out->auth_digest->buffer_len;
    activate_in->auth_digest->buffer = calloc(1,make_out->auth_digest->buffer_len);
    activate_in->credential = calloc(1,sizeof(ubi_buffer));
    activate_in->credential->buffer_len = (((*make_in).secret->buffer_len + IV_SIZE) / IV_SIZE) * IV_SIZE;
    activate_in->credential->buffer = calloc(1,make_out->credential->buffer_len);
    activate_in->encrypted_random_secret = calloc(1,sizeof(ubi_buffer));
    activate_in->encrypted_random_secret->buffer_len = make_out->encrypted_secret->buffer_len;
    activate_in->encrypted_random_secret->buffer = calloc(1,make_out->encrypted_secret->buffer_len);
    activate_in->key_d = calloc(1,sizeof(ubi_buffer));
    activate_in->key_d->buffer_len = sizeof(d);
    activate_in->key_d->buffer = calloc(1,activate_in->key_d->buffer_len);
    activate_in->key_e = calloc(1,sizeof(ubi_buffer));
    activate_in->key_e->buffer_len = sizeof(e);
    activate_in->key_e->buffer = calloc(1,activate_in->key_e->buffer_len);
    activate_in->key_n = calloc(1,sizeof(ubi_buffer));
    activate_in->key_n->buffer_len = sizeof(n);
    activate_in->key_n->buffer = calloc(1,activate_in->key_n->buffer_len);
    activate_in->key_name = calloc(1,sizeof(ubi_buffer));
    activate_in->key_name->buffer_len = make_in->key_name->buffer_len;
    activate_in->key_name->buffer = calloc(1,activate_in->key_name->buffer_len);
    activate_in->secret_size = make_in->secret->buffer_len;

    memcpy(activate_in->auth_digest->buffer, make_out->auth_digest->buffer, make_out->auth_digest->buffer_len);
    memcpy(activate_in->credential->buffer, make_out->credential->buffer, make_out->credential->buffer_len);
    memcpy(activate_in->encrypted_random_secret->buffer, make_out->encrypted_secret->buffer, make_out->encrypted_secret->buffer_len);
    memcpy(activate_in->iv, make_out->iv, IV_SIZE);
    memcpy(activate_in->key_d->buffer, d, activate_in->key_d->buffer_len);
    memcpy(activate_in->key_e->buffer, e, activate_in->key_e->buffer_len);
    memcpy(activate_in->key_n->buffer, n, activate_in->key_n->buffer_len);
    memcpy(activate_in->key_name->buffer, name, activate_in->key_name->buffer_len);

    ubi_activate_credential(activate_in, &activate_out);

    if (make_in) {
        if (make_in->key_e) {
            if (make_in->key_e->buffer) {
                free(make_in->key_e->buffer);
            }
            free(make_in->key_e);
        }

        if (make_in->key_n) {
            if (make_in->key_n->buffer) {
                free(make_in->key_n->buffer);
            }
            free(make_in->key_n);
        }

        if (make_in->key_name) {
            if (make_in->key_name->buffer) {
                free(make_in->key_name->buffer);
            }
            free(make_in->key_name);
        }

        if (make_in->secret) {
            if (make_in->secret->buffer) {
                free(make_in->secret->buffer);
            }
            free(make_in->secret);
        }

        free(make_in);
    }

    // Free make_out structure
    free_ubi_make_credential_out(make_out);

    // Free activate_in structure
    if (activate_in) {
        if (activate_in->auth_digest) {
            if (activate_in->auth_digest->buffer) {
                free(activate_in->auth_digest->buffer);
            }
            free(activate_in->auth_digest);
        }

        if (activate_in->credential) {
            if (activate_in->credential->buffer) {
                free(activate_in->credential->buffer);
            }
            free(activate_in->credential);
        }

        if (activate_in->encrypted_random_secret) {
            if (activate_in->encrypted_random_secret->buffer) {
                free(activate_in->encrypted_random_secret->buffer);
            }
            free(activate_in->encrypted_random_secret);
        }

        if (activate_in->key_d) {
            if (activate_in->key_d->buffer) {
                free(activate_in->key_d->buffer);
            }
            free(activate_in->key_d);
        }

        if (activate_in->key_e) {
            if (activate_in->key_e->buffer) {
                free(activate_in->key_e->buffer);
            }
            free(activate_in->key_e);
        }

        if (activate_in->key_n) {
            if (activate_in->key_n->buffer) {
                free(activate_in->key_n->buffer);
            }
            free(activate_in->key_n);
        }

        if (activate_in->key_name) {
            if (activate_in->key_name->buffer) {
                free(activate_in->key_name->buffer);
            }
            free(activate_in->key_name);
        }

        // No need to free secret_size as it's just a simple value, not a pointer

        free(activate_in);
    }

    free_ubi_activate_credential_out(activate_out);
    
    return 0;
}